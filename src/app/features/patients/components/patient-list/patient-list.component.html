<div class="page-header">
  <div>
    <h1>PatientsHub</h1>
    <p>Gestión de Pacientes con facilidad</p>
  </div>
  <div>
    <button
      pButton
      icon="pi pi-plus"
      label="Agregar Paciente"
      (click)="openCreatePatientModal()"
    ></button>
    <button
      pButton
      icon="pi pi-download"
      label="Exportar"
      (click)="openExportModal()"
      class="p-button-secondary"
    ></button>
  </div>
</div>

<p-card>
  <!-- Filters -->
  <div class="p-fluid grid">
    <div class="field col-12 md:col-4">
      <label for="nameFilter">Nombre</label>
      <input
        id="nameFilter"
        type="text"
        pInputText
        [(ngModel)]="nameFilter"
        placeholder="Filtrar por nombre..."
      />
    </div>
    <div class="field col-12 md:col-4">
      <label for="docFilter">Número de Documento</label>
      <input
        id="docFilter"
        type="text"
        pInputText
        [(ngModel)]="documentNumberFilter"
        placeholder="Filtrar por número de documento..."
      />
    </div>
    <div
      class="field col-12 md:col-4"
      style="display: flex; align-items: end; gap: 0.5rem"
    >
      <button
        pButton
        icon="pi pi-search"
        label="Buscar"
        (click)="applyFilters()"
      ></button>
      <button
        pButton
        icon="pi pi-refresh"
        label="Limpiar"
        (click)="clearFilters()"
        class="p-button-secondary"
      ></button>
    </div>
  </div>

  <!-- Data Table -->
  <p-table
    [value]="patients"
    [lazy]="true"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalRecords"
    [loading]="loading"
    (onLazyLoad)="onPageChange($event)"
    [rowsPerPageOptions]="[5, 10, 20, 50]"
    dataKey="patientId"
    styleClass="p-datatable-gridlines"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Documento</th>
        <th>Nombre</th>
        <th>Correo Electrónico</th>
        <th>Telefono</th>
        <th>Fecha de Creación</th>
        <th width="120px">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-patient>
      <tr>
        <td>{{ patient.documentType }} - {{ patient.documentNumber }}</td>
        <td>{{ patient.firstName }} {{ patient.lastName }}</td>
        <td>{{ patient.email || "-" }}</td>
        <td>{{ patient.phoneNumber || "-" }}</td>
        <td>{{ patient.createdAt | date : "medium" }}</td>
        <td>
          <div class="action-buttons">
            <button
              pButton
              icon="pi pi-eye"
              class="p-button-info p-button-sm"
              (click)="openViewPatientModal(patient)"
              pTooltip="Ver Detalles"
              tooltipPosition="top"
            ></button>
            <button
              pButton
              icon="pi pi-pencil"
              class="p-button-warning p-button-sm"
              (click)="openEditPatientModal(patient)"
              pTooltip="Editar Paciente"
              tooltipPosition="top"
            ></button>
            <button
              pButton
              icon="pi pi-trash"
              class="p-button-danger p-button-sm"
              (click)="confirmDelete(patient)"
              pTooltip="Eliminar Paciente"
              tooltipPosition="top"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">No se encontraron pacientes</td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-dialog
  header="Exportar Datos"
  [(visible)]="displayExportModal"
  [modal]="true"
  [draggable]="true"
  [resizable]="false"
  [closable]="true"
  appendTo="body"
  styleClass="export-modal"
>
  <div class="p-fluid">
    <div class="field">
      <label>Opciones de Exportación</label>
      <div class="p-field-radiobutton" style="margin-bottom: 0.5rem;">
        <p-radioButton
          id="exportAll"
          name="exportOption"
          value="all"
          [(ngModel)]="exportOption"
        ></p-radioButton>
        <label for="exportAll" style="margin-left: 0.5rem;">Exportar todos los pacientes</label>
      </div>
      <div class="p-field-radiobutton">
        <p-radioButton
          id="exportFiltered"
          name="exportOption"
          value="filtered"
          [(ngModel)]="exportOption"
        ></p-radioButton>
        <label for="exportFiltered" style="margin-left: 0.5rem;">Exportar pacientes creados después de una fecha específica</label>
      </div>
    </div>
    
    <div class="field" *ngIf="exportOption === 'filtered'">
      <label for="exportDate">Seleccionar fecha</label>
      <p-calendar
        id="exportDate"
        [(ngModel)]="exportDate"
        [showTime]="false"
        dateFormat="yy-mm-dd"
        appendTo="body"
        [keepInvalid]="false"
        [showIcon]="true"
        [touchUI]="false"
      ></p-calendar>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button
      pButton
      icon="pi pi-file-excel"
      label="Exportar a Excel"
      (click)="exportToExcel()"
      class="p-button-success"
    ></button>
    <button
      pButton
      icon="pi pi-file"
      label="Exportar a CSV"
      (click)="exportToCSV()"
      class="p-button-help"
    ></button>
    <button
      pButton
      icon="pi pi-times"
      label="Cancelar"
      (click)="displayExportModal = false"
      class="p-button-secondary"
    ></button>
  </ng-template>
</p-dialog>

<p-dialog
  [header]="modalMode === 'create' ? 'Crear Paciente' : 'Editar Paciente'"
  [(visible)]="displayPatientModal"
  [modal]="true"
  [draggable]="true"
  [resizable]="false"
  [closable]="true"
  [style]="{ width: '80vw', maxWidth: '800px', height: '90vh' }"
  styleClass="patient-modal"
  appendTo="body"
>
  <app-patient-form
    *ngIf="displayPatientModal"
    [patient]="selectedPatient"
    [mode]="modalMode"
    (patientSaved)="onPatientSaved()"
    (cancelled)="closePatientModal()"
  ></app-patient-form>
</p-dialog>

<p-dialog
  header="Detalles del Paciente"
  [(visible)]="displayDetailModal"
  [modal]="true"
  [draggable]="true"
  [resizable]="false"
  [closable]="true"
  [style]="{ width: '70vw', maxWidth: '600px', height: '80vh' }"
  styleClass="patient-detail-modal"
  appendTo="body"
>
  <app-patient-detail
    *ngIf="displayDetailModal && selectedPatient"
    [patient]="selectedPatient"
    (closed)="closePatientModal()"
  ></app-patient-detail>
</p-dialog>